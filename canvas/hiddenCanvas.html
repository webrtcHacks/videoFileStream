<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stream from Offscreen Canvas</title>
    <style>
        div#results {
            display: flex;
        }
    </style>
</head>
<body>
<button id="start">Start</button>
<div id="results">
    <div>
        <h3>Input video</h3>
        <video id="source" src="../BigBuckBunny_360p30.mp4" controls autoplay playsinline></video>
    </div>
    <div>
        <h3>MediaStream output</h3>
        <video id="output" controls autoplay playsinline></video>
    </div>
</div>
<br>
<button id="hide">Hide source</button>
<script>
    // Main Thread Script
    document.addEventListener("DOMContentLoaded", () => {
        const sourceVideo = document.getElementById("source");
        const outputVideo = document.getElementById("output");

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');


        sourceVideo.onplay = () => {
            canvas.width = sourceVideo.videoWidth;
            canvas.height = sourceVideo.videoHeight;
            requestAnimationFrame(processFrame);

            // Web Audio API to capture audio from the source video
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const sourceNode = audioCtx.createMediaElementSource(sourceVideo);
            const destinationNode = audioCtx.createMediaStreamDestination();

            // attempt to lower the volume on the input but increase it on the output
            // const gainNode = audioCtx.createGain(); // Create a gain node

            sourceNode.connect(destinationNode);
            sourceNode.connect(audioCtx.destination); // Connect to speakers to play audio

            // Combine video stream with audio stream
            const videoStream = canvas.captureStream();
            const audioStream = destinationNode.stream;
            const combinedStream = new MediaStream([...videoStream.getVideoTracks(), ...audioStream.getAudioTracks()]);


            // this doesn't work
            // const newAudioTrack = audioStream.getAudioTracks()[0].clone();
            // const combinedStream = new MediaStream([...videoStream.getVideoTracks(), newAudioTrack]);

            outputVideo.srcObject = combinedStream;

        };

        function processFrame() {
            if (sourceVideo.paused || sourceVideo.ended) return;
            ctx.drawImage(sourceVideo, 0, 0);
            requestAnimationFrame(processFrame);
        }

        const hideButton = document.querySelector('button#hide');
        hideButton.onclick = () => {
            sourceVideo.style.visibility = sourceVideo.style.visibility === "hidden" ? "visible" : "hidden"
            hideButton.innerText = sourceVideo.hidden ? "Unhide source" : "Hide source";

            // this mutes the output video too
            // sourceVideo.muted = !sourceVideo.muted;
            sourceVideo.volume = sourceVideo.volume === 0.01 ? 1.0 : 0.01;

            // doesn't work well
            // gainNode.gain.value = gainNode.gain.value === 40 ? 1 : 40;
        };

        const startButton = document.querySelector('button#start');
        startButton.onclick = () => {
            sourceVideo.play();
        };
    });

</script>
</body>
</html>
